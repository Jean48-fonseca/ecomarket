<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Prueba de Sesi√≥n Corregida - EcoMarket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #60e1f5 0%, #e0eafc 100%);
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2e7d32;
            margin: 0 0 10px 0;
        }
        
        .status-card {
            background: white;
            padding: 25px;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-title {
            color: #2e7d32;
            font-size: 1.3rem;
            margin-bottom: 15px;
            border-bottom: 2px solid #4caf50;
            padding-bottom: 8px;
        }
        
        .btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-primary {
            background: #2196F3;
        }
        
        .btn-primary:hover {
            background: #1976D2;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .navigation-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .nav-link {
            display: inline-block;
            background: #2196F3;
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .result-display {
            margin-top: 15px;
            min-height: 50px;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #45a049);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Diagn√≥stico de Sesi√≥n - EcoMarket</h1>
        <p>Herramienta para verificar las correcciones del sistema de sesiones</p>
        <div class="status" id="connectionStatus">
            <strong>üîç Verificando sistema...</strong>
        </div>
    </div>

    <div class="test-grid">
        <!-- Test de Login -->
        <div class="status-card">
            <h3 class="card-title">1. üë§ Test de Login</h3>
            <p>Simula un login completo con la estructura correcta de sesi√≥n</p>
            <button class="btn" onclick="testLoginProcess()">Simular Login</button>
            <button class="btn btn-danger" onclick="clearAllSessions()">Limpiar Todo</button>
            <div class="result-display" id="loginResult"></div>
        </div>

        <!-- Test de Sesi√≥n -->
        <div class="status-card">
            <h3 class="card-title">2. üîê Test de Sesi√≥n</h3>
            <p>Verifica el estado actual y validez de la sesi√≥n</p>
            <button class="btn" onclick="checkSessionStatus()">Verificar Sesi√≥n</button>
            <button class="btn" onclick="renewSessionTest()">Renovar Sesi√≥n</button>
            <div class="result-display" id="sessionResult"></div>
        </div>

        <!-- Test de Carrito -->
        <div class="status-card">
            <h3 class="card-title">3. üõí Test de Carrito</h3>
            <p>Prueba la integraci√≥n del carrito con la sesi√≥n corregida</p>
            <button class="btn" onclick="testCartIntegration()">Test Carrito</button>
            <button class="btn" onclick="addTestItemsToCart()">Agregar Items</button>
            <div class="result-display" id="cartResult"></div>
        </div>

        <!-- Test de Navegaci√≥n -->
        <div class="status-card">
            <h3 class="card-title">4. üß≠ Test de Navegaci√≥n</h3>
            <p>Verifica que la navegaci√≥n post-compra funcione</p>
            <button class="btn" onclick="testPostPurchaseNavigation()">Test Navegaci√≥n</button>
            <button class="btn" onclick="simulateCompletePurchase()">Simular Compra</button>
            <div class="result-display" id="navigationResult"></div>
        </div>
    </div>

    <!-- Diagn√≥stico en Tiempo Real -->
    <div class="status-card">
        <h3 class="card-title">üìä Monitor de Sistema</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="systemHealth"></div>
        </div>
        <div id="systemStatus"></div>
        <div class="log-container" id="systemLogs"></div>
        <button class="btn btn-primary" onclick="exportDiagnostic()">üìã Exportar Diagn√≥stico</button>
        <button class="btn" onclick="clearLogs()">üóëÔ∏è Limpiar Logs</button>
    </div>

    <div class="navigation-bar">
        <h4>üîó Navegaci√≥n de Prueba</h4>
        <a href="login.html" class="nav-link">üîê Login</a>
        <a href="Untitled-1.html" class="nav-link">üè† Lobby</a>
        <a href="carrito.html" class="nav-link">üõí Carrito</a>
        <a href="mis-pedidos.html" class="nav-link">üì¶ Mis Pedidos</a>
        <a href="test-session-flow.html" class="nav-link">üß™ Test Original</a>
    </div>

    <script>
        let diagnosticLogs = [];
        let testsPassed = 0;
        let totalTests = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleString();
            const logEntry = { timestamp, message, type };
            diagnosticLogs.push(logEntry);
            
            const logsContainer = document.getElementById('systemLogs');
            const logElement = document.createElement('div');
            logElement.className = `status ${type}`;
            logElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsContainer.appendChild(logElement);
            
            // Mantener solo los √∫ltimos 15 logs
            if (logsContainer.children.length > 15) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
            
            updateSystemHealth();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        function updateSystemHealth() {
            const healthBar = document.getElementById('systemHealth');
            const statusDiv = document.getElementById('systemStatus');
            
            if (totalTests === 0) {
                healthBar.style.width = '0%';
                statusDiv.innerHTML = '<div class="status info">üîÑ Sistema listo para pruebas</div>';
                return;
            }
            
            const percentage = (testsPassed / totalTests) * 100;
            healthBar.style.width = percentage + '%';
            
            let statusClass = 'success';
            let statusIcon = '‚úÖ';
            let statusText = 'Sistema funcionando correctamente';
            
            if (percentage < 50) {
                statusClass = 'error';
                statusIcon = '‚ùå';
                statusText = 'Sistema con problemas cr√≠ticos';
            } else if (percentage < 80) {
                statusClass = 'warning';
                statusIcon = '‚ö†Ô∏è';
                statusText = 'Sistema con problemas menores';
            }
            
            statusDiv.innerHTML = `
                <div class="status ${statusClass}">
                    ${statusIcon} <strong>${statusText}</strong><br>
                    Pruebas exitosas: ${testsPassed}/${totalTests} (${percentage.toFixed(1)}%)
                </div>
            `;
        }

        function getSession() {
            try {
                const sessionData = localStorage.getItem('ecomarket_session');
                if (!sessionData || sessionData === 'null') {
                    return null;
                }
                
                const session = JSON.parse(sessionData);
                
                if (!session || (!session.userId && !session.username)) {
                    log('Sesi√≥n inv√°lida detectada, limpiando...', 'error');
                    localStorage.removeItem('ecomarket_session');
                    return null;
                }
                
                if (session.expiresAt && new Date(session.expiresAt) < new Date()) {
                    log('Sesi√≥n expirada, limpiando...', 'error');
                    localStorage.removeItem('ecomarket_session');
                    return null;
                }
                
                return session;
            } catch (error) {
                log('Error al leer sesi√≥n: ' + error.message, 'error');
                localStorage.removeItem('ecomarket_session');
                return null;
            }
        }

        function renewSession() {
            const session = getSession();
            if (session) {
                session.lastActivity = new Date().toISOString();
                session.expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
                localStorage.setItem('ecomarket_session', JSON.stringify(session));
                log('Sesi√≥n renovada autom√°ticamente', 'success');
                return true;
            }
            return false;
        }

        function testLoginProcess() {
            totalTests++;
            const resultDiv = document.getElementById('loginResult');
            
            // Simular login con estructura corregida
            const testSession = {
                userId: 'test-user-' + Date.now(),
                username: 'cliente1',
                name: 'Usuario de Prueba',
                email: 'test@ecomarket.com',
                type: 'cliente',
                lastActivity: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                createdAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('ecomarket_session', JSON.stringify(testSession));
                
                // Verificar que se guard√≥ correctamente
                const savedSession = getSession();
                if (savedSession && savedSession.userId === testSession.userId) {
                    testsPassed++;
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>Login simulado exitoso</strong><br>
                            Usuario: ${savedSession.username} (${savedSession.name})<br>
                            ID: ${savedSession.userId}<br>
                            Expira: ${new Date(savedSession.expiresAt).toLocaleString()}
                        </div>
                    `;
                    log('Test de login exitoso', 'success');
                } else {
                    throw new Error('La sesi√≥n no se guard√≥ correctamente');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Error en login simulado</strong><br>
                        ${error.message}
                    </div>
                `;
                log('Test de login fall√≥: ' + error.message, 'error');
            }
        }

        function checkSessionStatus() {
            totalTests++;
            const resultDiv = document.getElementById('sessionResult');
            
            try {
                const session = getSession();
                if (session) {
                    testsPassed++;
                    const timeUntilExpiry = new Date(session.expiresAt) - new Date();
                    const hoursLeft = Math.floor(timeUntilExpiry / (1000 * 60 * 60));
                    
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>Sesi√≥n v√°lida y activa</strong><br>
                            Usuario: ${session.username}<br>
                            Tipo: ${session.type}<br>
                            Expira en: ${hoursLeft} horas<br>
                            <pre>${JSON.stringify(session, null, 2)}</pre>
                        </div>
                    `;
                    log('Verificaci√≥n de sesi√≥n exitosa', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå <strong>No hay sesi√≥n activa</strong><br>
                            Es necesario iniciar sesi√≥n primero
                        </div>
                    `;
                    log('No hay sesi√≥n activa', 'warning');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Error al verificar sesi√≥n</strong><br>
                        ${error.message}
                    </div>
                `;
                log('Error en verificaci√≥n de sesi√≥n: ' + error.message, 'error');
            }
        }

        function renewSessionTest() {
            totalTests++;
            const resultDiv = document.getElementById('sessionResult');
            
            try {
                if (renewSession()) {
                    testsPassed++;
                    const session = getSession();
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>Sesi√≥n renovada exitosamente</strong><br>
                            Nueva expiraci√≥n: ${new Date(session.expiresAt).toLocaleString()}
                        </div>
                    `;
                    log('Test de renovaci√≥n de sesi√≥n exitoso', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå <strong>No se pudo renovar la sesi√≥n</strong><br>
                            No hay sesi√≥n activa para renovar
                        </div>
                    `;
                    log('No se pudo renovar sesi√≥n - no hay sesi√≥n activa', 'warning');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Error al renovar sesi√≥n</strong><br>
                        ${error.message}
                    </div>
                `;
                log('Error en renovaci√≥n de sesi√≥n: ' + error.message, 'error');
            }
        }

        function testCartIntegration() {
            totalTests++;
            const resultDiv = document.getElementById('cartResult');
            
            try {
                const session = getSession();
                if (session) {
                    // Probar la clave del carrito espec√≠fica del usuario
                    const cartKey = `ecomarket_cart_${session.userId}`;
                    const cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
                    
                    testsPassed++;
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>Integraci√≥n de carrito exitosa</strong><br>
                            Clave del carrito: ${cartKey}<br>
                            Productos en carrito: ${cart.length}<br>
                            Usuario: ${session.username}
                        </div>
                    `;
                    log('Test de integraci√≥n de carrito exitoso', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå <strong>No se puede acceder al carrito</strong><br>
                            Sesi√≥n requerida para el carrito
                        </div>
                    `;
                    log('No se puede acceder al carrito sin sesi√≥n', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Error en test de carrito</strong><br>
                        ${error.message}
                    </div>
                `;
                log('Error en test de carrito: ' + error.message, 'error');
            }
        }

        function addTestItemsToCart() {
            const session = getSession();
            const resultDiv = document.getElementById('cartResult');
            
            if (session) {
                const cartKey = `ecomarket_cart_${session.userId}`;
                const testItems = [
                    { id: 1, name: 'Manzana Org√°nica', price: 3.50, qty: 2, img: 'https://placehold.co/80x80?text=üçé' },
                    { id: 2, name: 'Pan Integral', price: 4.20, qty: 1, img: 'https://placehold.co/80x80?text=üçû' },
                    { id: 3, name: 'Leche Fresca', price: 5.80, qty: 1, img: 'https://placehold.co/80x80?text=ü•õ' }
                ];
                
                localStorage.setItem(cartKey, JSON.stringify(testItems));
                
                resultDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ <strong>Items agregados al carrito</strong><br>
                        Se agregaron ${testItems.length} productos de prueba<br>
                        Total: S/ ${testItems.reduce((sum, item) => sum + (item.price * item.qty), 0).toFixed(2)}
                    </div>
                `;
                log(`${testItems.length} items agregados al carrito de ${session.username}`, 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>No se pueden agregar items</strong><br>
                        Sesi√≥n requerida
                    </div>
                `;
                log('No se pueden agregar items sin sesi√≥n', 'error');
            }
        }

        function testPostPurchaseNavigation() {
            totalTests++;
            const resultDiv = document.getElementById('navigationResult');
            
            try {
                const session = getSession();
                if (session && renewSession()) {
                    testsPassed++;
                    resultDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ <strong>Navegaci√≥n post-compra OK</strong><br>
                            Sesi√≥n renovada antes de navegaci√≥n<br>
                            <a href="Untitled-1.html" target="_blank" class="nav-link">üîó Probar Lobby</a>
                            <a href="mis-pedidos.html" target="_blank" class="nav-link">üîó Probar Pedidos</a>
                        </div>
                    `;
                    log('Test de navegaci√≥n post-compra exitoso', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå <strong>Problema en navegaci√≥n</strong><br>
                            Error con sesi√≥n o renovaci√≥n
                        </div>
                    `;
                    log('Error en test de navegaci√≥n post-compra', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Error en test de navegaci√≥n</strong><br>
                        ${error.message}
                    </div>
                `;
                log('Error en test de navegaci√≥n: ' + error.message, 'error');
            }
        }

        function simulateCompletePurchase() {
            const session = getSession();
            const resultDiv = document.getElementById('navigationResult');
            
            if (session) {
                // Simular proceso completo de compra
                renewSession();
                
                // Crear pedido simulado
                const testOrder = {
                    id: 'PED-' + Date.now(),
                    fecha: new Date().toISOString(),
                    usuario: session.username,
                    userId: session.userId,
                    productos: [
                        { id: 1, nombre: 'Producto Test', precio: 10.50, cantidad: 2, subtotal: 21.00 }
                    ],
                    subtotal: 21.00,
                    entrega: 0,
                    total: 21.00,
                    metodoPago: 'Yape',
                    estado: 'pendiente',
                    fechaCreacion: new Date().toISOString()
                };
                
                // Guardar pedido
                let pedidos = JSON.parse(localStorage.getItem('ecomarket_pedidos') || '[]');
                pedidos.push(testOrder);
                localStorage.setItem('ecomarket_pedidos', JSON.stringify(pedidos));
                
                // Limpiar carrito simulado
                const cartKey = `ecomarket_cart_${session.userId}`;
                localStorage.removeItem(cartKey);
                
                resultDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ <strong>Compra simulada completada</strong><br>
                        Pedido: ${testOrder.id}<br>
                        Total: S/ ${testOrder.total.toFixed(2)}<br>
                        M√©todo: ${testOrder.metodoPago}<br>
                        Sesi√≥n mantenida: ‚úÖ
                    </div>
                `;
                log('Compra simulada completada exitosamente', 'success');
            } else {
                resultDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>No se puede simular compra</strong><br>
                        Sesi√≥n requerida
                    </div>
                `;
                log('No se puede simular compra sin sesi√≥n', 'error');
            }
        }

        function clearAllSessions() {
            localStorage.removeItem('ecomarket_session');
            localStorage.removeItem('ecomarket_pedidos');
            
            // Limpiar todos los carritos
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('ecomarket_cart_')) {
                    localStorage.removeItem(key);
                }
            });
            
            testsPassed = 0;
            totalTests = 0;
            
            document.getElementById('loginResult').innerHTML = '<div class="status info">üóëÔ∏è Sesiones eliminadas</div>';
            document.getElementById('sessionResult').innerHTML = '<div class="status info">üóëÔ∏è Datos limpiados</div>';
            document.getElementById('cartResult').innerHTML = '<div class="status info">üóëÔ∏è Carrito limpiado</div>';
            document.getElementById('navigationResult').innerHTML = '<div class="status info">üóëÔ∏è Pedidos eliminados</div>';
            
            log('Todas las sesiones y datos fueron eliminados', 'info');
            updateSystemHealth();
        }

        function clearLogs() {
            diagnosticLogs = [];
            document.getElementById('systemLogs').innerHTML = '';
            log('Logs del sistema limpiados', 'info');
        }

        function exportDiagnostic() {
            const diagnosticData = {
                timestamp: new Date().toISOString(),
                systemHealth: {
                    testsPassed,
                    totalTests,
                    percentage: totalTests > 0 ? (testsPassed / totalTests) * 100 : 0
                },
                currentSession: getSession(),
                logs: diagnosticLogs,
                localStorage: Object.keys(localStorage).reduce((obj, key) => {
                    if (key.startsWith('ecomarket_')) {
                        obj[key] = localStorage.getItem(key);
                    }
                    return obj;
                }, {})
            };
            
            const blob = new Blob([JSON.stringify(diagnosticData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ecomarket-diagnostic-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Diagn√≥stico exportado exitosamente', 'success');
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('Sistema de diagn√≥stico iniciado', 'info');
            
            // Verificar conexi√≥n inicial
            const connectionStatus = document.getElementById('connectionStatus');
            setTimeout(() => {
                connectionStatus.innerHTML = '<strong>‚úÖ Sistema listo para pruebas</strong>';
                connectionStatus.className = 'status success';
            }, 1000);
            
            // Auto-verificar si hay sesi√≥n existente
            const existingSession = getSession();
            if (existingSession) {
                log(`Sesi√≥n existente detectada: ${existingSession.username}`, 'info');
            }
        });

        // Monitor de cambios en localStorage
        window.addEventListener('storage', function(e) {
            if (e.key && e.key.startsWith('ecomarket_')) {
                log(`Cambio detectado en ${e.key}`, 'info');
            }
        });
    </script>
</body>
</html>