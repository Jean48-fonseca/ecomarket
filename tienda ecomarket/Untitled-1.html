  <script>
    // Insertar usuarios de ejemplo automáticamente si la base está vacía
    (async function autoSeedUsers(){
      if(!window.EcoDB) return;
      const users = await EcoDB.listUsers().catch(()=>[]);
      if(!users || users.length === 0){
        await EcoDB.seedSample();
        console.log('Usuarios de ejemplo creados:');
        console.log('Cliente: usuario="cliente1" contraseña="passCliente1"');
        console.log('Cliente: usuario="cliente2" contraseña="passCliente2"');
        console.log('Empleado: usuario="trabajador1" contraseña="trabPass1" código="EMP-1001"');
        console.log('Empleado: usuario="trabajador2" contraseña="trabPass2" código="EMP-1002"');
      }
    })();
  </script>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoMarket</title>
  <meta name="description" content="EcoMarket - Tu mercado, en un clic. Busca y filtra productos frescos con ayuda de EcoIA." />

  <style>
    :root{
      --primary:#4ec8c2;
      --accent:#d70606;
      --text:#2d3436;
      --bg1:#60e1f5;
      --bg2:#e0eafc;
      --heroTextLight:#ffffff;

      --cardBg:#ffffff;
      --muted:#6c757d;
      --chip:#eef6f6;
      --chipText:#276e6a;
    }

    .sr-only{
      position:absolute!important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
    }

    /* Header */
    header.header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 22px;
      background:#fff;
      box-shadow: 0 2px 12px rgba(0,0,0,.08);
    }
    .header .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; color:var(--primary);
      letter-spacing:.5px;
  cursor:pointer;
    }
    .header .brand .logo{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px;
      color:var(--primary);
    }

    .search-bar{
      display:flex; align-items:center; gap:8px;
    }
    .search-bar input[type="search"],
    .search-bar select{
      padding:8px 12px; font-size:16px;
      border:1px solid #b2bec3; border-radius:8px;
      background:#fff; color:#2d3436;
      outline:none; transition:border-color .2s, box-shadow .2s;
    }
    .search-bar input[type="search"]:focus,
    .search-bar select:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(78,200,194,.15);
    }

    .icon-button{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px;height:40px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      color:var(--primary);
      cursor:pointer;
      transition:transform .15s, color .2s, box-shadow .2s, border-color .2s;
      position:relative;
    }
    .icon-button:hover{
      color:var(--accent);
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
      border-color:rgba(0,0,0,.12);
    }
    .icon-button:focus-visible{
      outline:none;
      box-shadow:0 0 0 3px rgba(78,200,194,.35);
    }
    .icon-button svg{ width:20px; height:20px; }

    .session{
      display:flex; align-items:center; gap:8px; margin-left:10px;
      font-size:14px; color:#394046;
    }
    .link{
      color:var(--primary); cursor:pointer; text-decoration:underline; text-underline-offset:2px;
    }

    /* Badge carrito */
    .cart-badge{
      position:absolute; top:-6px; right:-6px;
      min-width:18px; height:18px; padding:0 4px;
      border-radius:999px;
      background:var(--accent); color:#fff;
      font-size:12px; display:flex; align-items:center; justify-content:center;
    }

    /* Hero / Título */
    .titulo-animado{
      text-align:center;
      font-family: "Arial Black", Arial, sans-serif;
      color: var(--heroTextLight);
      background-image: url('https://www.mesopinions.com/public/img/petition/petition-img-111999-fr.png');
      background-size: cover;
      background-position: center;
      padding: 56px 12px 44px;
      margin: 36px auto 10px;
      width: min(90vw, 980px);
      border-radius: 24px;
      box-shadow: 0 10px 34px rgba(0,0,0,.12);
      position: relative;
      overflow: hidden;
      animation: mover 1.6s infinite alternate ease-in-out;
    }
    .titulo-animado::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.25));
      z-index:1;
      border-radius:24px;
    }
    .titulo-animado span{
      position:relative; z-index:2;
      display:inline-block;
    }
    @keyframes mover{
      from{
        letter-spacing: 2px;
        color: #4ec8c2;
        transform: scale(1) rotate(-2deg);
        text-shadow: 0 2px 8px rgba(0,0,0,.2);
      }
      to{
        letter-spacing: 12px;
        color: #fad961;
        transform: scale(1.04) rotate(2deg);
        text-shadow: 0 8px 22px rgba(0,0,0,.35);
      }
    }
    @media (prefers-reduced-motion: reduce){
      .titulo-animado{ animation:none }
    }

    .subtitulo{
      text-align:center;
      font-size: clamp(1rem, 2.5vw, 1.35rem);
      font-weight:500;
      color:#3d3d3d;
      margin: 0 auto 24px;
      letter-spacing:1.2px;
      text-shadow:0 2px 12px #fff8;
      width:min(90vw, 900px);
    }

    .container{ width:min(92vw, 1160px); margin:0 auto; padding-bottom:48px; }

    /* EcoIA */
    .ai-box{
      background:#ffffffc7;
      backdrop-filter: blur(4px);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 6px 20px rgba(0,0,0,.10);
      border-radius:16px;
      padding:14px;
      display:grid; gap:10px;
      margin: 18px auto 10px;
      width:min(92vw, 1160px);
    }
    .ai-box .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ai-input{
      flex:1;
      padding:10px 12px; font-size:16px;
      border:1px solid #b2bec3; border-radius:10px; outline:none;
      transition:border-color .2s, box-shadow .2s;
      background:#fff;
    }
    .ai-input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(78,200,194,.15); }
    .chip{
      border:none; background:var(--chip); color:var(--chipText);
      padding:8px 12px; border-radius:999px; cursor:pointer; font-size:14px;
    }
    .ai-meta{
      font-size:13px; color:var(--muted);
    }

    /* Filtros rápidos */
    .quick-filters{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
    .quick-filters .chip{ background:#f3f6ff; color:#2a4b8d; }

    /* Grid de productos */
    .grid{
      display:grid;
      grid-template-columns: repeat(1, 1fr);
      gap:16px;
      margin-top:18px;
    }
    @media (min-width: 520px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 860px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1140px){ .grid{ grid-template-columns: repeat(4, 1fr); } }

    .card{
      background:var(--cardBg);
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      display:flex; flex-direction:column;
      transition: transform .15s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.10); }

    .thumb{
      position:relative; width:100%;
      aspect-ratio:16/11; background:#eef2f7;
      overflow:hidden;
    }
    .thumb img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .pill{
      position:absolute; left:10px; top:10px;
      background:#00000080; color:#fff; font-size:12px; padding:4px 8px; border-radius:999px;
      backdrop-filter: blur(2px);
    }
    .content{ padding:12px 12px 14px; display:grid; gap:8px; }
    .name{ font-weight:700; }
    .price{ color:#0f7b6c; font-weight:700; }
    .tags{ display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      font-size:12px; background:#f4f6f8; color:#3b3b3b; padding:4px 8px; border-radius:999px;
      border:1px solid #e9ecef;
    }
    .actions{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:0 12px 12px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.08);
      background:#fff; color:var(--primary); cursor:pointer;
      transition: transform .15s, box-shadow .15s, color .2s, border-color .2s;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.12); color:var(--accent); border-color:rgba(0,0,0,.12); }
    .btn svg{ width:18px; height:18px; }

    /* Resultados y estado */
    .status-bar{
      margin-top:10px; font-size:14px; color:var(--muted);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
    }
  </style>
</head>
<body>
  <script src="db.js"></script>
  <!-- Header -->
  <header class="header">
    <div class="brand" id="brandLoginLink" role="link" tabindex="0" aria-label="Ir a iniciar sesión para comprar">
      <span class="logo" aria-hidden="true">
        <!-- Hoja como logo -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Logo hoja">
          <path d="M3 21c9 0 18-9 18-18 0 0-9 0-18 9s-9 18 0 9Z"/>
        </svg>
      </span>
      <span>EcoMarket</span>
    </div>

    <form class="search-bar" role="search" aria-label="Buscar productos" action="#" method="get" id="searchForm">
      <label class="sr-only" for="q">Buscar</label>
      <input id="q" name="q" type="search" placeholder="Buscar productos..." aria-label="Buscar productos" />

      <label class="sr-only" for="cat">Categoría</label>
      <select id="cat" name="categoria" aria-label="Filtrar por categoría">
        <option value="all">Todas</option>
        <option value="verduras">Verduras</option>
        <option value="legumbres">Legumbres</option>
        <option value="frutas">Frutas</option>
        <option value="cereales">Cereales</option>
        <option value="embutidos">Embutidos</option>
        <option value="otros">Otros</option>
      </select>

      <!-- Botón buscar (lupa) -->
      <button type="submit" class="icon-button" aria-label="Buscar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Lupa">
          <circle cx="11" cy="11" r="7"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <span class="sr-only">Buscar</span>
      </button>
    </form>

  <!-- Carrito -->
  <button class="icon-button" type="button" aria-label="Ver carrito" id="cartBtn" onclick="window.location.href='carrito.html'">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Carrito">
        <path d="M3 3h2l2.2 10.4a2 2 0 0 0 2 1.6h7.6a2 2 0 0 0 2-1.6L21 7H6"></path>
        <circle cx="10" cy="20" r="1.5"></circle>
        <circle cx="18" cy="20" r="1.5"></circle>
      </svg>
      <span class="cart-badge" id="cartBadge" aria-hidden="true" hidden>0</span>
      <span class="sr-only" aria-live="polite" id="cartLive">Carrito vacío</span>
    </button>
  <div class="session" id="sessionInfo" aria-live="polite"></div>
  </header>
  <div style="text-align:center;margin:10px 0;">
    <a href="libro-reclamaciones.html" style="color:#4ec8c2;text-decoration:underline;margin-right:16px;">Libro de Reclamaciones</a>
    <a href="mis-pedidos.html" style="color:#4ec8c2;text-decoration:underline;">Mis pedidos</a>
  </div>

  <!-- Hero -->
  <h1 class="titulo-animado" aria-label="EcoMarket, ofertas frescas y eco">
    <span>EcoMarket</span>
  </h1>
  <p class="subtitulo">Tu mercado, en un clic</p>

  <!-- EcoIA -->
  <section class="ai-box" aria-label="Asistente EcoIA">
    <div class="row">
      <input class="ai-input" id="aiInput" type="text" placeholder="Pregúntale a EcoIA: 'fruta barata para jugo', 'lentejas orgánicas', 'menos de 3', 'enbutidos'..." aria-label="Pregunta a EcoIA" />
      <button class="chip" id="aiAskBtn" aria-label="Consultar a EcoIA">Preguntar</button>
    </div>
    <div class="row quick-filters" aria-label="Sugerencias rápidas">
      <button class="chip" data-q="fruta barata para jugo">Fruta barata</button>
      <button class="chip" data-q="verduras para ensalada">Verduras p/ensalada</button>
      <button class="chip" data-q="legumbres orgánicas">Legumbres orgánicas</button>
      <button class="chip" data-q="cereales sin gluten">Cereales sin gluten</button>
      <button class="chip" data-q="embutidos oferta">Embutidos en oferta</button>
      <button class="chip" data-q="productos locales">Productos locales</button>
    </div>
    <div class="ai-meta" id="aiMeta">EcoIA entenderá tu intención y aplicará filtros automáticamente.</div>
  </section>

  <main class="container" aria-label="Contenido principal">
    <div class="status-bar">
      <div id="resultCount">Mostrando 0 productos</div>
      <div id="activeFilters"></div>
    </div>

    <!-- Grid -->
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Template tarjeta -->
  <template id="cardTmpl">
    <article class="card">
      <div class="thumb">
        <img loading="lazy" decoding="async" alt="" />
        <span class="pill"></span>
      </div>
      <div class="content">
        <div class="name"></div>
        <div class="price"></div>
        <div class="tags"></div>
      </div>
      <div class="actions">
        <button class="btn addBtn" type="button" aria-label="Agregar al carrito">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
          </svg>
          Agregar
        </button>
        <div class="unit"></div>
      </div>
    </article>
  </template>

  <script>
    // Utilidades
    const normalize = (s='') =>
      s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();

  const FALLBACK_IMG = 'https://placehold.co/800x550?text=Sin+imagen';

    // Overrides de imágenes por producto (id -> url)
    const IMG_OV_KEY = 'ecomarket_img_overrides';
    function getImgOverrides(){ try{ return JSON.parse(localStorage.getItem(IMG_OV_KEY)||'{}'); }catch{ return {}; } }
    function setImgOverrides(map){ try{ localStorage.setItem(IMG_OV_KEY, JSON.stringify(map||{})); }catch{} }
    function imgForProduct(p){ const o = getImgOverrides(); return (o && o[p.id]) ? o[p.id] : p.img; }

    // Catálogo de productos con imágenes
    const IMG = (q) => `https://source.unsplash.com/featured/800x550?${encodeURIComponent(q)}`;

    const products = [
      // Verduras
      {id:'v1', name:'Lechuga Romana', category:'verduras', price:1.6, unit:'pieza', img:IMG('lettuce, green'), tags:['fresco','ensalada','verde','local']},
      {id:'v2', name:'Tomate', category:'verduras', price:1.9, unit:'kg', img:IMG('tomato, fresh'), tags:['ensalada','rojo','jugoso','oferta']},
      {id:'v3', name:'Zanahoria', category:'verduras', price:1.5, unit:'kg', img:IMG('carrot, vegetables'), tags:['dulce','crujiente','ensalada']},
      {id:'v4', name:'Pepino', category:'verduras', price:1.4, unit:'kg', img:IMG('cucumber'), tags:['refrescante','ensalada']},
      {id:'v5', name:'Pimiento Verde', category:'verduras', price:2.2, unit:'kg', img:IMG('green bell pepper'), tags:['ensalada','vitamina-c']},
      {id:'v6', name:'Cebolla Morada', category:'verduras', price:1.8, unit:'kg', img:IMG('red onion'), tags:['ensalada','aroma']},

      // Legumbres
      {id:'l1', name:'Lentejas', category:'legumbres', price:2.6, unit:'kg', img:IMG('lentils'), tags:['proteina','fibra','organico']},
      {id:'l2', name:'Garbanzos', category:'legumbres', price:2.8, unit:'kg', img:IMG('chickpeas'), tags:['hummus','proteina','fibra']},
      {id:'l3', name:'Frijoles Negros', category:'legumbres', price:2.4, unit:'kg', img:IMG('black beans'), tags:['proteina','guiso']},

      // Frutas
      {id:'f1', name:'Manzana Roja', category:'frutas', price:2.3, unit:'kg', img:IMG('red apple fruit'), tags:['dulce','snack','jugo']},
      {id:'f2', name:'Plátano', category:'frutas', price:1.7, unit:'kg', img:IMG('banana bunch'), tags:['desayuno','energia']},
      {id:'f3', name:'Naranja', category:'frutas', price:2.0, unit:'kg', img:IMG('orange fruit'), tags:['jugo','vitamina-c','citricos']},
      {id:'f4', name:'Fresa', category:'frutas', price:3.1, unit:'kg', img:IMG('strawberries'), tags:['postre','dulce']},

      // Cereales
      {id:'c1', name:'Arroz Integral', category:'cereales', price:2.2, unit:'kg', img:IMG('brown rice'), tags:['sin-gluten','fibra','acompanante']},
      {id:'c2', name:'Avena', category:'cereales', price:2.1, unit:'kg', img:IMG('oats'), tags:['desayuno','fibra']},
      {id:'c3', name:'Quinoa', category:'cereales', price:4.5, unit:'kg', img:IMG('quinoa seeds'), tags:['sin-gluten','proteina','premium']},

      // Embutidos
      {id:'e1', name:'Jamón Cocido', category:'embutidos', price:3.8, unit:'250g', img:IMG('ham slices'), tags:['sandwich','oferta']},
      {id:'e2', name:'Chorizo', category:'embutidos', price:4.2, unit:'250g', img:IMG('chorizo sausage'), tags:['fuerte','guiso']},
      {id:'e3', name:'Salchicha de Pavo', category:'embutidos', price:3.4, unit:'300g', img:IMG('turkey sausage'), tags:['sandwich','light']},

      // Otros
      {id:'o1', name:'Huevos (docena)', category:'otros', price:2.7, unit:'12u', img:IMG('eggs carton'), tags:['proteina','desayuno','local']},
      {id:'o2', name:'Leche Entera', category:'otros', price:1.3, unit:'1L', img:IMG('milk bottle'), tags:['lacteos','desayuno']},
      {id:'o3', name:'Aceite de Oliva', category:'otros', price:6.9, unit:'500ml', img:IMG('olive oil bottle'), tags:['cocina','premium']},
      {id:'o4', name:'Yogur Natural', category:'otros', price:0.9, unit:'200g', img:IMG('yogurt cup'), tags:['lacteos','desayuno','light']}
      // Productos adicionales
      ,{id:'v7', name:'Ajo', category:'verduras', price:3.0, unit:'kg', img:IMG('garlic'), tags:['condimento','fresco']}
      ,{id:'v8', name:'Berenjena', category:'verduras', price:2.0, unit:'kg', img:IMG('eggplant'), tags:['verdura','guiso']}
      ,{id:'v9', name:'Espárragos', category:'verduras', price:5.5, unit:'kg', img:IMG('asparagus'), tags:['premium','verdura']}

      ,{id:'l4', name:'Soja', category:'legumbres', price:3.2, unit:'kg', img:IMG('soybeans'), tags:['proteina','vegetariano']}
      ,{id:'l5', name:'Alubias Blancas', category:'legumbres', price:2.9, unit:'kg', img:IMG('white beans'), tags:['guiso','proteina']}

      ,{id:'f5', name:'Mango', category:'frutas', price:2.9, unit:'kg', img:IMG('mango fruit'), tags:['dulce','jugo','tropical']}
      ,{id:'f6', name:'Piña', category:'frutas', price:3.5, unit:'kg', img:IMG('pineapple'), tags:['tropical','jugo']}
      ,{id:'f7', name:'Kiwis', category:'frutas', price:2.7, unit:'kg', img:IMG('kiwi fruit'), tags:['vitamina-c','snack']}

      ,{id:'c4', name:'Harina de Trigo', category:'cereales', price:1.9, unit:'kg', img:IMG('wheat flour'), tags:['hornear','cocina']}
      ,{id:'c5', name:'Semillas de Chía', category:'cereales', price:4.8, unit:'200g', img:IMG('chia seeds'), tags:['superfood','fibra']}

      ,{id:'e4', name:'Pavo Ahumado', category:'embutidos', price:5.0, unit:'200g', img:IMG('smoked turkey'), tags:['premium','sandwich']}
      ,{id:'e5', name:'Salami', category:'embutidos', price:4.6, unit:'200g', img:IMG('salami slices'), tags:['sandwich','picante']}

      ,{id:'o5', name:'Miel Natural', category:'otros', price:6.2, unit:'250g', img:IMG('honey jar'), tags:['dulce','natural']}
      ,{id:'o6', name:'Café Molido', category:'otros', price:5.9, unit:'250g', img:IMG('ground coffee'), tags:['desayuno','energia']}
      ,{id:'o7', name:'Té Verde', category:'otros', price:3.4, unit:'20 bolsitas', img:IMG('green tea'), tags:['infusion','salud']}
    ];

    // Sinónimos e intención para EcoIA
    const categorySynonyms = new Map([
      ['verduras',['verdura','hortaliza','hortalizas','greens','vegetales','vegetal']],
      ['legumbres',['legumbre','frijol','frijoles','poroto','porotos','garbanzo','garbanzos','lenteja','lentejas']],
      ['frutas',['fruta','frutal','frutales']],
      ['cereales',['cereal','granos','grano','quinoa','avena','arroz']],
      ['embutidos',['embutido','fiambre','jamon','chorizo','salchicha','enbutidos','enbutido']], // incluye variante con b
      ['otros',['otro','varios','miscelaneo','miscelaneos','variedad','lacteos','huevos','aceite']]
    ]);

    const tagSynonyms = new Map([
      ['organico',['organico','ecologico','eco','bio']],
      ['oferta',['oferta','promo','descuento','barato','barata']],
      ['sin-gluten',['sin gluten','gluten free','sg']],
      ['ensalada',['ensalada','ensaladas','fresh','crudites']],
      ['jugo',['jugo','zumo','licuado']],
      ['local',['local','kilometro cero','km0','km 0']],
      ['dulce',['dulce','sweet']],
      ['desayuno',['desayuno','breakfast']],
      ['premium',['premium','gourmet','caro','alta']]
    ]);

    // Estado UI
    const state = {
      q: '',
      category: 'all',
      ai: {
        priceCap: null,
        priceMin: null,
        inferredCategory: null,
        tags: new Set()
      },
      cartCount: 0
    };

    // Referencias (única definición)
    const gridEl = document.getElementById('grid');
    const countEl = document.getElementById('resultCount');
    const activeFiltersEl = document.getElementById('activeFilters');
    const formEl = document.getElementById('searchForm');
    const qEl = document.getElementById('q');
    const catEl = document.getElementById('cat');
    const aiInput = document.getElementById('aiInput');
    const aiBtn = document.getElementById('aiAskBtn');
    const aiMeta = document.getElementById('aiMeta');
    const cartBadge = document.getElementById('cartBadge');
    const cartLive = document.getElementById('cartLive');
  const brandLoginLink = document.getElementById('brandLoginLink');
    const sessionInfo = document.getElementById('sessionInfo');

    function getSession(){
      try{ return JSON.parse(localStorage.getItem('ecomarket_session')||'null'); }catch{ return null; }
    }
    function clearSession(){
      localStorage.removeItem('ecomarket_session');
      state.cartCount = 0;
      if(cartBadge){ cartBadge.hidden = true; cartBadge.textContent = '0'; }
      if(cartLive){ cartLive.textContent = 'Carrito vacío'; }
    }
    function getCartKey(){
      const s = getSession();
      if(!s) return null;
      const uid = s.userId || s.username || 'anon';
      return 'ecomarket_cart_'+ encodeURIComponent(uid);
    }
    function migrateLegacyCartIfNeeded(){
      const key = getCartKey();
      if(!key) return;
      const legacy = localStorage.getItem('ecomarket_cart');
      if(legacy && !localStorage.getItem(key)){
        try{ localStorage.setItem(key, legacy); localStorage.removeItem('ecomarket_cart'); }catch{}
      }
    }
    function updateCartBadge(){
      const key = getCartKey();
      let cart = [];
      if(key){
        try{ cart = JSON.parse(localStorage.getItem(key)||'[]'); }catch{ cart = []; }
      }
      const totalQty = cart.reduce((sum, item)=> sum + (item.qty||1), 0);
      state.cartCount = key ? totalQty : 0;
      cartBadge.hidden = !key || totalQty === 0;
      cartBadge.textContent = String(state.cartCount);
      cartLive.textContent = (!key || totalQty === 0) ? 'Carrito vacío' : `Carrito: ${state.cartCount} producto${state.cartCount>1?'s':''}`;
    }
    async function renderSession(){
      const s = getSession();
      if(!s){ sessionInfo.innerHTML = '<span>No has iniciado sesión</span>'; return; }
      let nombre = s.username;
      if (window.EcoDB && s.userId) {
        const user = await EcoDB.findUserByUsername(s.username);
        if(user && user.first_name && user.last_name){
          nombre = user.first_name + ' ' + user.last_name;
        }
      }
      let adminLink = '';
      if(window.EcoDB && s.userId){
        try{
          const worker = await EcoDB.findWorkerByUserId(s.userId);
          if(worker && worker.is_admin===1){
            adminLink = ` · <a class="link" href="admin-pedidos.html">Admin Pedidos</a>`;
          }
        }catch{}
      }
      sessionInfo.innerHTML = `<span>Hola, ${nombre}</span>${adminLink} · <span id="logoutLink" class="link" role="button" tabindex="0">Cerrar sesión</span>`;
      const logout = ()=>{ clearSession(); location.reload(); };
      const el = document.getElementById('logoutLink');
      if(el){ el.addEventListener('click', logout); el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); logout(); } }); }
    }

    // Render tarjetas
    function render(productsList){
      gridEl.innerHTML = '';
      const tmpl = document.getElementById('cardTmpl');

      for(const p of productsList){
        const node = tmpl.content.cloneNode(true);
        const pill = node.querySelector('.pill');
        const imgEl = node.querySelector('.thumb img');
        const name = node.querySelector('.name');
        const price = node.querySelector('.price');
        const tags = node.querySelector('.tags');
        const unit = node.querySelector('.unit');
        const addBtn = node.querySelector('.addBtn');

        // Imagen del producto con fallback, referrerPolicy y overrides
        imgEl.referrerPolicy = 'no-referrer';
        const imgSrc = imgForProduct(p);
        imgEl.src = imgSrc;
        imgEl.alt = p.name;
        imgEl.onerror = () => {
          const txt = encodeURIComponent(p.name || 'Sin imagen');
          const ph = `https://placehold.co/800x550?text=${txt}`;
          if (imgEl.src !== ph) imgEl.src = ph;
        };

        pill.textContent = capitalize(p.category);
        name.textContent = p.name;
        price.textContent = formatPrice(p.price);
        unit.textContent = p.unit ? `Unidad: ${p.unit}` : '';

        // Tags
        tags.innerHTML = '';
        const tagList = [...(p.tags||[])].slice(0,4);
        for(const t of tagList){
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = t;
          tags.appendChild(span);
        }

        addBtn.addEventListener('click', ()=>{
          const sess = getSession();
          if(!sess){
            const ret = encodeURIComponent(location.href);
            alert('Debes iniciar sesión para agregar productos. Te llevaremos al login.');
            location.href = `login.html?return=${ret}`;
            return;
          }
          // Leer carrito actual por usuario
          const cartKey = getCartKey();
          let cart = [];
          try { cart = JSON.parse(localStorage.getItem(cartKey)||'[]'); } catch { cart = []; }
          // Buscar si ya existe el producto
          const idx = cart.findIndex(item => item.id === p.id);
          if(idx >= 0){
            cart[idx].qty = (cart[idx].qty||1) + 1;
          } else {
            const imgToStore = imgForProduct(p);
            cart.push({id: p.id, name: p.name, price: p.price, qty: 1, img: imgToStore});
          }
          localStorage.setItem(cartKey, JSON.stringify(cart));
          // Actualizar badge
          const totalQty = cart.reduce((sum, item) => sum + (item.qty||1), 0);
          state.cartCount = totalQty;
          cartBadge.hidden = false;
          cartBadge.textContent = String(state.cartCount);
          cartLive.textContent = `Carrito: ${state.cartCount} producto${state.cartCount>1?'s':''}`;
        });

        gridEl.appendChild(node);
      }

      countEl.textContent = `Mostrando ${productsList.length} producto${productsList.length!==1?'s':''}`;
      renderActiveFilters();
    }

    function renderActiveFilters(){
      const chips = [];
      if(state.category !== 'all') chips.push(`Categoría: ${capitalize(state.category)}`);
      if(state.q) chips.push(`Búsqueda: "${state.q}"`);
      if(state.ai.inferredCategory) chips.push(`EcoIA → ${capitalize(state.ai.inferredCategory)}`);
      if(state.ai.priceCap != null) chips.push(`Máx: ${formatPrice(state.ai.priceCap)}`);
      if(state.ai.priceMin != null) chips.push(`Mín: ${formatPrice(state.ai.priceMin)}`);
      if(state.ai.tags.size) chips.push(`Etiquetas: ${[...state.ai.tags].join(', ')}`);
      activeFiltersEl.textContent = chips.join(' · ');
    }

    const capitalize = s => s ? s[0].toUpperCase()+s.slice(1) : s;
    const formatPrice = n => 'S/ ' + n.toFixed(2);

    // Búsqueda + ranking
    function searchAndRank(){
      const q = normalize(state.q);
      const terms = q.split(/\s+/).filter(Boolean);
      const hasPriceBias = state.ai.priceCap != null || state.ai.priceMin != null;

      const catFilter = (prod) => {
        if(state.category === 'all') return true;
        return prod.category === state.category;
      };

      const aiCatFilter = (prod) => {
        if(!state.ai.inferredCategory) return true;
        return prod.category === state.ai.inferredCategory;
      };

      const aiTagFilter = (prod) => {
        if(!state.ai.tags.size) return true;
        const nTags = new Set((prod.tags||[]).map(t=>normalize(t)));
        for(const t of state.ai.tags) if(!nTags.has(t)) return false;
        return true;
      };

      let list = products.filter(p => catFilter(p) && aiCatFilter(p) && aiTagFilter(p));

      // Scoring
      const scored = list.map(p=>{
        const nName = normalize(p.name);
        const nTags = (p.tags||[]).map(t=>normalize(t));
        let score = 0;

        for(const t of terms){
          if(!t) continue;
          if(nName.startsWith(t)) score += 8;
          else if(nName.includes(t)) score += 5;
          if(nTags.some(x=>x.startsWith(t))) score += 4;
          else if(nTags.some(x=>x.includes(t))) score += 2;
        }

        // Bonus por EcoIA
        if(state.ai.inferredCategory && p.category === state.ai.inferredCategory) score += 6;
        for(const t of state.ai.tags) if(nTags.includes(t)) score += 3;

        // Precio
        if(state.ai.priceCap != null){
          if(p.price <= state.ai.priceCap) score += 5;
          else score -= 5;
        }
        if(state.ai.priceMin != null){
          if(p.price >= state.ai.priceMin) score += 3;
          else score -= 4;
        }

        // Popularidad ficticia
        if(nTags.includes('oferta')) score += 2;
        if(nTags.includes('premium')) score += 1;

        return {p, score};
      });

      // Orden
      scored.sort((a,b)=>{
        if(b.score !== a.score) return b.score - a.score;
        if(hasPriceBias) return a.p.price - b.p.price;
        return a.p.price - b.p.price;
      });

      return scored.map(x=>x.p);
    }

    // Parseo de intención EcoIA
    function parseAI(textRaw){
      const text = normalize(textRaw);
      state.ai = { priceCap:null, priceMin:null, inferredCategory:null, tags:new Set() };

      // Categoría
      for(const [cat, syns] of categorySynonyms.entries()){
        if(text.includes(cat) || syns.some(s=>text.includes(normalize(s)))){
          state.ai.inferredCategory = cat;
          break;
        }
      }

      // Etiquetas
      for(const [tag, syns] of tagSynonyms.entries()){
        if(text.includes(tag) || syns.some(s=>text.includes(normalize(s)))){
          state.ai.tags.add(tag);
        }
      }

      // Precio: "menos de 3", "< 4", "hasta 2.5", "máximo 3"
      const menosDe = text.match(/(menos de|hasta|<|maximo|max)\s*\$?\s*([\d]+([.,]\d+)?)/);
      if(menosDe){
        state.ai.priceCap = parseFloat(menosDe[2].replace(',','.'));
      }else if(text.includes('barato') || text.includes('barata') || text.includes('oferta')){
        state.ai.priceCap = 3.0;
      }

      // Mínimo: "desde 3", "> 2.5", "min 2"
      const desde = text.match(/(desde|>|minimo|min)\s*\$?\s*([\d]+([.,]\d+)?)/);
      if(desde){
        state.ai.priceMin = parseFloat(desde[2].replace(',','.'));
      }else if(text.includes('caro') || text.includes('premium')){
        state.ai.priceMin = 3.5;
      }

      if(!qEl.value){
        state.q = text;
        qEl.value = textRaw;
      }

      const parts = [];
      if(state.ai.inferredCategory) parts.push(`Categoría: ${capitalize(state.ai.inferredCategory)}`);
      if(state.ai.priceCap != null) parts.push(`Máx: ${formatPrice(state.ai.priceCap)}`);
      if(state.ai.priceMin != null) parts.push(`Mín: ${formatPrice(state.ai.priceMin)}`);
      if(state.ai.tags.size) parts.push(`Etiquetas: ${[...state.ai.tags].join(', ')}`);
      aiMeta.textContent = parts.length ? `EcoIA aplicó → ${parts.join(' · ')}` : 'EcoIA no detectó filtros específicos; usando búsqueda libre.';
    }

    // Controladores
    formEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      state.q = qEl.value.trim();
      state.category = catEl.value;
      const results = searchAndRank();
      render(results);
    });

    qEl.addEventListener('input', ()=>{
      state.q = qEl.value.trim();
      const results = searchAndRank();
      render(results);
    });

    catEl.addEventListener('change', ()=>{
      state.category = catEl.value;
      const results = searchAndRank();
      render(results);
    });

    aiBtn.addEventListener('click', ()=>{
      parseAI(aiInput.value);
      const results = searchAndRank();
      render(results);
    });

    aiInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        parseAI(aiInput.value);
        const results = searchAndRank();
        render(results);
      }
    });

    document.querySelectorAll('.quick-filters .chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        aiInput.value = btn.dataset.q;
        parseAI(btn.dataset.q);
        const results = searchAndRank();
        render(results);
        qEl.value = btn.dataset.q;
        state.q = qEl.value.trim();
      });
    });

  // Inicial
  // Al cargar, migrar carrito antiguo a uno por usuario y restaurar badge
  migrateLegacyCartIfNeeded();
  updateCartBadge();
  window.addEventListener('storage', (e)=>{
    const key = getCartKey();
    if(!key) return;
    if(e.key === key){
      updateCartBadge();
    }
  });
  render(products);
  renderSession();

    // Navegación a Login: al hacer clic en "EcoMarket" junto al buscador
    if(brandLoginLink){
      const goLogin = ()=>{
        const ret = encodeURIComponent(location.href);
        location.href = `login.html?return=${ret}`;
      };
      brandLoginLink.addEventListener('click', goLogin);
      brandLoginLink.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          goLogin();
        }
      });
      brandLoginLink.title = 'Haz clic para iniciar sesión o registrarte';
    }

    // --- Panel administrativo: IndexedDB para usuarios y trabajadores ---
    // UI mínima añadida dinámicamente
    (function addAdminPanel(){
      const adminHtml = `
      <section aria-label="Panel admin" style="max-width:980px;margin:18px auto;padding:12px;background:#ffffffc7;border-radius:12px;">
        <h3 style="margin:0 0 8px;">Panel administrativo (DB en el navegador)</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
          <button id="createDbBtn" class="btn" type="button">Crear DB</button>
          <button id="seedDbBtn" class="btn" type="button">Insertar ejemplos</button>
          <button id="listUsersBtn" class="btn" type="button">Listar usuarios</button>
          <button id="listWorkersBtn" class="btn" type="button">Listar trabajadores</button>
        </div>
        <div id="adminOutput" style="background:#f8f9fa;border:1px solid #e9ecef;padding:10px;border-radius:8px;max-height:260px;overflow:auto;font-family:monospace;font-size:13px;">
          Estado del panel admin.
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid #e9ecef" />
        <h4 style="margin:0 0 8px;">Imágenes de productos (id → URL)</h4>
        <div class="row" style="display:grid;gap:8px;grid-template-columns:1fr;">
          <textarea id="imgOverrides" placeholder='{"c3":"https://.../quinoa.jpg","v2":"https://.../tomate.jpg","v1":"https://.../lechuga-romana.jpg","v3":"https://.../zanahoria.jpg"}' style="min-height:120px;border:1px solid #e9ecef;border-radius:8px;padding:8px"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnLoadOverrides" class="btn" type="button">Cargar overrides</button>
            <button id="btnSaveOverrides" class="btn" type="button">Guardar overrides</button>
            <button id="btnApplyOverrides" class="btn" type="button">Aplicar al catálogo</button>
          </div>
        </div>
      </section>
      `;
      const container = document.createElement('div');
      container.innerHTML = adminHtml;
      document.querySelector('.container').insertAdjacentElement('afterend', container);

      document.getElementById('createDbBtn').addEventListener('click', async ()=>{
        await EcoDB.dbOpen();
        adminLog('IndexedDB creada/abierta.');
      });
      document.getElementById('seedDbBtn').addEventListener('click', async ()=>{
        await EcoDB.seedSample();
        adminLog('Datos de ejemplo insertados (si no existían).');
      });
      document.getElementById('listUsersBtn').addEventListener('click', async ()=>{
        const u = await EcoDB.listUsers();
        adminLog(JSON.stringify(u, null, 2));
      });
      document.getElementById('listWorkersBtn').addEventListener('click', async ()=>{
        const w = await EcoDB.listWorkers();
        adminLog(JSON.stringify(w, null, 2));
      });

      // Overrides UI
      const loadOverridesUI = ()=>{
        const map = getImgOverrides();
        document.getElementById('imgOverrides').value = JSON.stringify(map, null, 2);
      };
      document.getElementById('btnLoadOverrides').addEventListener('click', loadOverridesUI);
      document.getElementById('btnSaveOverrides').addEventListener('click', ()=>{
        try{
          const txt = document.getElementById('imgOverrides').value;
          const obj = JSON.parse(txt || '{}');
          setImgOverrides(obj);
          adminLog('Overrides guardados.');
        }catch(e){ alert('JSON inválido: '+e.message); }
      });
      document.getElementById('btnApplyOverrides').addEventListener('click', ()=>{
        render(searchAndRank());
        adminLog('Overrides aplicados al catálogo.');
      });

      loadOverridesUI();
    })();

    function adminLog(msg){
      const el = document.getElementById('adminOutput');
      const now = new Date().toISOString();
      el.textContent = `${now} - ${msg}\n` + el.textContent;
    }
    // Los helpers de DB/crypto fueron centralizados en db.js (EcoDB)

    // Seed/merge de overrides: aplica claves faltantes sin sobrescribir las existentes
    (function seedImageOverrides(){
      const cur = getImgOverrides();
      const seed = {
        c3: 'https://www.rockrecipes.com/wp-content/uploads/2014/02/Quinoa-700-Depositphotos_21434411_xl-2015-1.jpg',
        v2: 'https://img.freepik.com/foto-gratis/vista-lateral-cercana-tomates-apetitosos-tomates-tallos-sobre-fondo-negro_140725-122963.jpg',
        // Lechuga Romana
        v1: 'https://thumbs.dreamstime.com/b/lechuga-fresca-aislada-en-el-fondo-blanco-66236095.jpg',
        // Zanahoria
        v3: 'https://i.pinimg.com/originals/c7/01/0d/c7010d69c044a2e0037f0bf560987ed6.jpg'
      };
      let changed = false;
      for(const k in seed){
        if(Object.prototype.hasOwnProperty.call(seed, k)){
          if(!cur[k]){ cur[k] = seed[k]; changed = true; }
        }
      }
      if(changed){
        setImgOverrides(cur);
        console.log('Overrides de imagen actualizados (se agregaron claves faltantes).');
      }
    })();

  </script>
</body>
</html>