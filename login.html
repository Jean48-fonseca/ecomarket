<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión - EcoMarket</title>
  <meta name="description" content="Login de EcoMarket para clientes y empleados." />
  <style>
    :root{
      --primary:#4ec8c2; --accent:#d70606; --text:#2d3436; --bg:#f4f9fb;
      --panel:#ffffff; --muted:#6c757d; --border:#e9ecef;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:linear-gradient(135deg,#60e1f5,#e0eafc)}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{width:min(92vw,980px);background:var(--panel);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--primary)}
    .brand svg{width:26px;height:26px}
    .tabs{display:flex;gap:6px}
    .tab{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
    .tab[aria-selected="true"]{background:var(--primary);color:#fff;border-color:transparent}
    .grid{display:grid;grid-template-columns:1fr 1fr;align-items:center}
    .img-col{display:flex;align-items:center;justify-content:center;padding:18px;}
    .img-col img{max-width:100%;height:auto;border-radius:14px;box-shadow:0 2px 12px #0001;max-height:420px;}
    
    /* Responsive login */
    @media (max-width: 768px) {
      .wrap {
        padding: 12px;
      }
      
      .card {
        width: 98vw;
        border-radius: 12px;
      }
      
      header {
        flex-direction: column;
        gap: 12px;
        padding: 12px 16px;
        text-align: center;
      }
      
      .brand {
        font-size: 18px;
      }
      
      .tabs {
        gap: 8px;
        width: 100%;
        justify-content: center;
      }
      
      .tab {
        flex: 1;
        padding: 10px 16px;
        font-size: 14px;
        text-align: center;
      }
      
      .grid {
        grid-template-columns: 1fr !important;
      }
      
      .img-col {
        padding: 12px;
        order: -1;
      }
      
      .img-col img {
        max-height: 180px;
        border-radius: 10px;
      }
      
      .col {
        padding: 16px;
      }
      
      input {
        font-size: 16px; /* Evita zoom en iOS */
        padding: 12px;
      }
      
      .actions {
        flex-direction: column;
        gap: 10px;
      }
      
      button {
        width: 100%;
        padding: 12px;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .wrap {
        padding: 8px;
      }
      
      .card {
        width: 100vw;
        border-radius: 8px;
        border: none;
      }
      
      header {
        padding: 10px 12px;
      }
      
      .brand {
        font-size: 16px;
      }
      
      .brand svg {
        width: 22px;
        height: 22px;
      }
      
      .tab {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .img-col img {
        max-height: 140px;
      }
      
      .col {
        padding: 12px;
      }
      
      h2 {
        font-size: 20px;
      }
    }
    
    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .img-col img {
        max-height: 420px;
      }
    }
    .col{padding:18px}
    h2{margin:0 0 10px}
    form{display:grid;gap:10px}
    .row{display:grid;gap:6px}
    label{font-size:14px;color:#394046}
    input{padding:10px 12px;border:1px solid #b2bec3;border-radius:10px;font-size:16px}
    input:focus{outline:none;box-shadow:0 0 0 3px rgba(78,200,194,.15);border-color:var(--primary)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:#fff;color:var(--primary);cursor:pointer}
    button.primary{background:var(--primary);color:#fff;border-color:transparent}
    .muted{color:var(--muted);font-size:13px}
    .notice{background:#f8f9fa;border:1px solid var(--border);padding:10px;border-radius:8px;font-size:13px;color:#394046}
    .error{color:#b00020}
  </style>
</head>
<body>
  <script src="db.js"></script>
  <div class="wrap">
    <div class="card" role="dialog" aria-labelledby="title" aria-modal="true">
      <header>
        <div class="brand">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 21c9 0 18-9 18-18 0 0-9 0-18 9s-9 18 0 9Z"/></svg>
          <span>EcoMarket</span>
        </div>
        <nav class="tabs" role="tablist" aria-label="Tipo de usuario">
          <button class="tab" id="tabCliente" role="tab" aria-selected="true" aria-controls="panelCliente">Cliente</button>
          <button class="tab" id="tabEmpleado" role="tab" aria-selected="false" aria-controls="panelEmpleado">Empleado</button>
        </nav>
      </header>
      <div class="grid">
        <div class="img-col">
          <img src="./images/Gemini_Generated_Image_s2xc0ks2xc0ks2xc.png" alt="Familia en EcoMarket" onerror="this.src='./images/login-family.svg'" loading="lazy" />
        </div>
        <section class="col" id="panelCliente" role="tabpanel" aria-labelledby="tabCliente">
          <h2 id="title">Cliente</h2>
          <p class="muted">Inicia sesión o regístrate como cliente.</p>
          <form id="loginClienteForm">
            <div class="row">
              <label for="cUser">Usuario</label>
              <input id="cUser" autocomplete="username" required />
            </div>
            <div class="row">
              <label for="cPass">Contraseña</label>
              <input id="cPass" type="password" autocomplete="current-password" required />
            </div>
            <div class="actions">
              <button type="submit" class="primary">Iniciar sesión</button>
              <button type="button" id="goRegisterCliente">Registrarme</button>
            </div>
            <div id="cError" class="error" role="alert" aria-live="polite"></div>
          </form>
          <form id="registerClienteForm" hidden>
            <div class="row"><label for="rcUser">Usuario</label><input id="rcUser" required /></div>
            <div class="row"><label for="rcEmail">Email</label><input id="rcEmail" type="email" required /></div>
            <div class="row"><label for="rcPass">Contraseña</label><input id="rcPass" type="password" required /></div>
            <div class="row"><label for="rcName">Nombre</label><input id="rcName" required /></div>
            <div class="row"><label for="rcLast">Apellido</label><input id="rcLast" required /></div>
            <div class="actions">
              <button type="submit" class="primary">Crear cuenta</button>
              <button type="button" id="cancelRegCli">Cancelar</button>
            </div>
            <div id="rcError" class="error" role="alert" aria-live="polite"></div>
          </form>
        </section>
        <section class="col" id="panelEmpleado" role="tabpanel" aria-labelledby="tabEmpleado" hidden>
          <h2>Empleado</h2>
          <p class="muted">Usa tu código de empleado para ingresar.</p>
          <form id="loginEmpleadoForm">
            <div class="row"><label for="eUser">Usuario</label><input id="eUser" required /></div>
            <div class="row"><label for="ePass">Contraseña</label><input id="ePass" type="password" required /></div>
            <div class="row"><label for="eCode">Código de empleado</label><input id="eCode" required /></div>
            <div class="actions">
              <button type="submit" class="primary">Ingresar</button>
            </div>
            <div id="eError" class="error" role="alert" aria-live="polite"></div>
          </form>
        </section>
      </div>
      <div style="padding:0 18px 18px">
        <p class="notice">Consejo: si vienes desde la página principal, al completar el inicio de sesión serás devuelto automáticamente para comprar.</p>
      </div>
    </div>
  </div>
  <script>
    // Verificar EcoDB antes de cualquier acción
    async function checkEcoDB(){
      if(!window.EcoDB || typeof EcoDB.findUserByUsername!=='function'){
        document.body.innerHTML = '<div style="max-width:500px;margin:60px auto;padding:32px 18px;background:#fff;border-radius:14px;box-shadow:0 8px 32px #0002;text-align:center;font-size:1.2em;color:#d70606;">'+
        '<b>Error crítico:</b><br> No se pudo cargar la base de datos del sistema (EcoDB).<br><br>'+ 
        'Por favor, recarga la página con <b>Ctrl+F5</b> o borra la caché del navegador.<br><br>'+ 
        'Si el problema persiste, contacta soporte técnico.'+
        '</div>';
        throw new Error('EcoDB no está disponible');
      }
      
      // Inicializar base de datos
      await EcoDB.dbOpen();
      
      // Crear usuarios predeterminados si no existen
      if(typeof EcoDB.listUsers==='function' && typeof EcoDB.initializeDefaultUsers==='function'){
        const users = await EcoDB.listUsers().catch(()=>[]);
        if(!users || users.length===0){
          await EcoDB.initializeDefaultUsers();
          console.log('Usuarios predeterminados creados.');
          console.log('Credenciales disponibles:');
          console.log('- cliente1 / cliente123');
          console.log('- admin / admin123');
          console.log('- empleado1 / emp123');
          console.log('- gerente / gerente123');
        }
      }
    }

    // Alternar entre tabs Cliente/Empleado
    function switchTab(activeTabId, activePanelId){
      document.querySelectorAll('.tab').forEach(tab => {
        tab.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('[role="tabpanel"]').forEach(panel => {
        panel.hidden = true;
      });
      
      document.getElementById(activeTabId).setAttribute('aria-selected', 'true');
      document.getElementById(activePanelId).hidden = false;
    }

    document.getElementById('tabCliente').addEventListener('click', () => {
      switchTab('tabCliente', 'panelCliente');
    });

    document.getElementById('tabEmpleado').addEventListener('click', () => {
      switchTab('tabEmpleado', 'panelEmpleado');
    });

    // Alternar entre login y registro de cliente
    document.getElementById('goRegisterCliente').addEventListener('click', () => {
      document.getElementById('loginClienteForm').hidden = true;
      document.getElementById('registerClienteForm').hidden = false;
    });

    document.getElementById('cancelRegCli').addEventListener('click', () => {
      document.getElementById('loginClienteForm').hidden = false;
      document.getElementById('registerClienteForm').hidden = true;
    });

    // Login de cliente
    document.getElementById('loginClienteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('cUser').value.trim();
      const password = document.getElementById('cPass').value;
      const errorDiv = document.getElementById('cError');
      
      errorDiv.textContent = '';
      
      if(!username || !password){
        errorDiv.textContent = 'Por favor, completa todos los campos.';
        return;
      }

      try {
        await checkEcoDB();
        
        // Usar la nueva función de validación
        const result = await EcoDB.validateLogin(username, password);
        if (!result.success) {
          errorDiv.textContent = result.error;
          return;
        }
        
        const user = result.user;
        
        // Login exitoso
        const sessionObj = {
          userId: user.id,
          username: user.username,
          name: user.first_name + ' ' + user.last_name,
          email: user.email,
          type: 'cliente',
          lastActivity: new Date().toISOString(),
          expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
          createdAt: new Date().toISOString()
        };
        if (typeof EcoSession !== 'undefined') {
          EcoSession.saveSession(sessionObj);
          try{ EcoSession.migrateGuestCartToUser(sessionObj.userId); }catch{}
        } else {
          localStorage.setItem('ecomarket_session', JSON.stringify(sessionObj));
        }
        
        // Redireccionar
        const returnUrl = new URLSearchParams(window.location.search).get('return') || './Untitled-1.html';
        window.location.href = returnUrl;
        
      } catch (error) {
        console.error('Error en login:', error);
        errorDiv.textContent = 'Error del sistema. Inténtalo de nuevo.';
      }
    });

    // Registro de cliente
    document.getElementById('registerClienteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('rcUser').value.trim();
      const email = document.getElementById('rcEmail').value.trim();
      const password = document.getElementById('rcPass').value;
      const firstName = document.getElementById('rcName').value.trim();
      const lastName = document.getElementById('rcLast').value.trim();
      const errorDiv = document.getElementById('rcError');
      
      errorDiv.textContent = '';
      
      if(!username || !email || !password || !firstName || !lastName){
        errorDiv.textContent = 'Por favor, completa todos los campos.';
        return;
      }
      
      if(password.length < 6){
        errorDiv.textContent = 'La contraseña debe tener al menos 6 caracteres.';
        return;
      }

      try {
        await checkEcoDB();
        
        // Verificar si el usuario ya existe
        const existingUser = await EcoDB.findUserByUsername(username);
        if(existingUser){
          errorDiv.textContent = 'Este nombre de usuario ya está en uso.';
          return;
        }
        
        // Crear usuario
        const userId = await EcoDB.addUser({
          username,
          password,
          firstName,
          lastName,
          email
        });
        
        // Login automático
        const sessionObj2 = {
          userId: userId,
          username,
          name: firstName + ' ' + lastName,
          email: email,
          type: 'cliente',
          lastActivity: new Date().toISOString(),
          expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
          createdAt: new Date().toISOString()
        };
        if (typeof EcoSession !== 'undefined') {
          EcoSession.saveSession(sessionObj2);
          try{ EcoSession.migrateGuestCartToUser(sessionObj2.userId); }catch{}
        } else {
          localStorage.setItem('ecomarket_session', JSON.stringify(sessionObj2));
        }
        
        // Redireccionar
        const returnUrl = new URLSearchParams(window.location.search).get('return') || './Untitled-1.html';
        window.location.href = returnUrl;
        
      } catch (error) {
        console.error('Error en registro:', error);
        errorDiv.textContent = 'Error al crear la cuenta. Inténtalo de nuevo.';
      }
    });

    // Login de empleado
    document.getElementById('loginEmpleadoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('eUser').value.trim();
      const password = document.getElementById('ePass').value;
      const employeeCode = document.getElementById('eCode').value.trim();
      const errorDiv = document.getElementById('eError');
      
      errorDiv.textContent = '';
      
      if(!username || !password || !employeeCode){
        errorDiv.textContent = 'Por favor, completa todos los campos.';
        return;
      }

      try {
        await checkEcoDB();
        
        // Buscar empleado por código
        const worker = await EcoDB.findWorkerByCode(employeeCode);
        if(!worker){
          errorDiv.textContent = 'Código de empleado no válido.';
          return;
        }
        
        // Verificar usuario asociado
        const user = await EcoDB.findUserById(worker.userId);
        if(!user || user.username !== username){
          errorDiv.textContent = 'Usuario no coincide con el código de empleado.';
          return;
        }
        
        // Verificar contraseña
        const isValid = await EcoDB.verifyPassword(password, user.password_salt, user.password_hash);
        if(!isValid){
          errorDiv.textContent = 'Contraseña incorrecta.';
          return;
        }
        
        // Login exitoso
        const sessionObj3 = {
          userId: user.id,
          username: user.username,
          name: user.first_name + ' ' + user.last_name,
          email: user.email,
          type: 'empleado',
          department: worker.department,
          position: worker.position,
          employeeCode: worker.employeeCode,
          lastActivity: new Date().toISOString(),
          expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
          createdAt: new Date().toISOString()
        };
        if (typeof EcoSession !== 'undefined') {
          EcoSession.saveSession(sessionObj3);
          try{ EcoSession.migrateGuestCartToUser(sessionObj3.userId); }catch{}
        } else {
          localStorage.setItem('ecomarket_session', JSON.stringify(sessionObj3));
        }
        
        // Redireccionar
        window.location.href = './Untitled-1.html';
        
      } catch (error) {
        console.error('Error en login de empleado:', error);
        errorDiv.textContent = 'Error del sistema. Inténtalo de nuevo.';
      }
    });

    // Inicialización
    checkEcoDB().catch(console.error);
  </script>
</body>
</html>